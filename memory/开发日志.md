# 凡人修仙项目开发日志

## Phase 4: AI聊天与每日总结系统 ✅ 已完成

### 开发时间
- 开始: 2026-02-14
- 完成: 2026-02-14

### 实现内容

#### 1. 箴言系统 (Wisdom System)
- **文件**: `src/config/wisdom.ts`
- **来源**: 《渔樵问对》邵雍 + 宇宙意识论修仙哲学
- **内容**: 30条精选哲学语录
  - 《渔樵问对》20条：涵盖哲理、修炼、宇宙、心性、自然
  - 宇宙意识论10条：修仙心法与现代宇宙观结合

#### 2. 箴言服务
- **文件**: `src/services/wisdomService.ts`
- **功能**:
  - 获取用户当日箴言（基于日期确定性随机）
  - 根据用户五行属性推荐相关箴言
  - 随机箴言获取（探索模式）
  - 箴言感悟记录
  - 每日总结生成

#### 3. 箴言 API 路由
- **文件**: `src/routes/wisdom.ts`

| 接口 | 方法 | 路径 | 功能 |
|------|------|------|------|
| 获取今日箴言 | GET | /api/wisdom/daily | 获取与用户五行契合的当日箴言 |
| 获取随机箴言 | GET | /api/wisdom/random | 随机获取一条箴言（可筛选分类/五行） |
| 获取箴言集合 | GET | /api/wisdom/collection | 获取多条箴言 |
| 获取每日总结 | GET | /api/wisdom/daily-summary | 获取当日修炼总结与建议 |
| 记录感悟 | POST | /api/wisdom/insight | 记录用户对某条箴言的感悟 |
| 获取感悟历史 | GET | /api/wisdom/insights | 获取用户的箴言感悟记录 |
| 获取分类列表 | GET | /api/wisdom/categories | 获取箴言分类 |

#### 4. 数据库更新
- **新增表**:
  - `DailyWisdom`: 记录用户每日查看的箴言
  - `WisdomInsight`: 用户箴言感悟
  - `CultivationLog`: 修炼日志（详细记录每次修炼）
  - `ResourceLog`: 资源变动日志

#### 5. 用户反馈整合
- ✅ 已加入《渔樵问对》经典语录
- ✅ 根据用户五行属性推荐相生/同属性箴言
- ✅ 箴言包含原文、出处、五行属性、解读

### API 响应示例

**GET /api/wisdom/daily**
```json
{
  "success": true,
  "data": {
    "quote": {
      "id": "yq003",
      "content": "无心则无意，无意则无我，无我则与天地合其德。",
      "source": "《渔樵问对》",
      "category": "mind",
      "element": "木",
      "context": "放下执念，达到无我之境，方能与天地同频，感应大道。"
    },
    "isFirstView": true,
    "totalViews": 1
  }
}
```

**GET /api/wisdom/daily-summary**
```json
{
  "success": true,
  "data": {
    "date": "2026-02-14",
    "cultivationMinutes": 45,
    "expGained": 45,
    "realmProgress": 25.5,
    "spiritStonesEarned": 4,
    "dailyQuote": { ... },
    "cultivationTip": "木主生发，今日宜早起修炼，借朝阳生发之气。"
  }
}
```

### 后续计划
- Phase 5: 前端界面开发
  - 箴言展示组件
  - 每日总结页面
  - 箴言感悟输入

---

## Phase 2: 八字命格计算 API ✅ 已完成

### 开发时间
- 开始: 2026-02-13
- 完成: 2026-02-13

### 实现内容

#### 1. 核心算法模块
- **文件**: `src/utils/baziCalculator.ts`
- **功能**:
  - 年柱计算: 基于 `(year - 4) % 10/12` 公式
  - 月柱计算: 月支固定 + 五虎遁推月干
  - 日柱计算: 基于1900-01-31甲子日基准推算
  - 时柱计算: 十二时辰 + 五鼠遁推时干
  - 五行统计: 天干 + 地支主五行
  - 灵根判定: 天灵根、双灵根、三灵根、四灵根、五灵根、变异灵根

- **文件**: `src/utils/wuxing.ts`
- **功能**:
  - 天干地支常量定义
  - 五行对应关系
  - 时辰表
  - 五虎遁、五鼠遁算法
  - 灵根类型定义和加成系数

#### 2. API 接口
- **文件**: `src/controllers/baziController.ts`
- **文件**: `src/routes/baziRoutes.ts`

| 接口 | 方法 | 路径 | 认证 | 功能 |
|------|------|------|------|------|
| 计算并保存八字 | POST | /api/v1/bazi/calculate | 需要 | 计算八字并保存到用户记录 |
| 获取我的八字 | GET | /api/v1/bazi/me | 需要 | 获取当前用户的八字信息 |
| 纯计算八字 | POST | /api/v1/bazi/compute | 无需 | 仅计算八字，不保存 |

#### 3. 请求/响应格式

**请求格式 (POST /api/v1/bazi/calculate)**:
```json
{
  "birthYear": 1990,
  "birthMonth": 5,
  "birthDay": 15,
  "birthHour": 14,
  "birthMinute": 30,
  "timezone": "Asia/Shanghai"
}
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "bazi": {
      "year": { "stem": "庚", "branch": "午", "element": "金" },
      "month": { "stem": "甲", "branch": "午", "element": "木" },
      "day": { "stem": "己", "branch": "亥", "element": "土" },
      "hour": { "stem": "辛", "branch": "未", "element": "金" }
    },
    "wuxing": {
      "metal": 2,
      "wood": 1,
      "water": 1,
      "fire": 2,
      "earth": 2
    },
    "lingGen": {
      "type": "wu",
      "name": "五灵根",
      "primaryElement": "金",
      "bonus": 0.8,
      "description": "伪灵根，五行俱全却无一精通，修炼艰难，但若能大成可修五行神通"
    }
  }
}
```

#### 4. 灵根判定规则

| 灵根类型 | 判定条件 | 修炼加成 |
|----------|----------|----------|
| 天灵根 (tian) | 单一五行 ≥ 4 | +50% |
| 双灵根 (shuang) | 两种五行各 ≥ 2，其余为0 | +20% |
| 三灵根 (san) | 三种五行各 1-2 | +0% |
| 四灵根 (si) | 四种五行各 1 | -10% |
| 五灵根 (wu) | 五行俱全 | -20% |
| 变异灵根 (bianyi) | 特殊组合（金水→冰，木火→雷等） | +30% |

#### 5. 测试记录

**API 测试通过**:
- ✅ POST /api/v1/bazi/compute - 公开计算接口
- ✅ POST /api/v1/bazi/calculate - 需认证的计算保存接口
- ✅ GET /api/v1/bazi/me - 需认证的查询接口
- ✅ 参数验证 - 缺少参数、无效日期
- ✅ 认证验证 - 未登录访问受保护接口

**灵根计算测试**:
- ✅ 五灵根: 1990-05-15 14:30
- ✅ 变异灵根·风: 1984-01-01 0:00 (木水相生)
- ✅ 时辰边界测试: 子、午等时辰计算正确

### 文件列表
```
src/
├── utils/
│   ├── baziCalculator.ts    # 八字核心算法
│   └── wuxing.ts            # 五行工具和常量
├── controllers/
│   └── baziController.ts    # API 控制器
├── routes/
│   ├── bazi.ts              # 旧版路由 (保留兼容)
│   └── baziRoutes.ts        # v1 API 路由
└── app.ts                   # 应用入口 (已更新)
```

### 后续计划
- Phase 3: 修炼系统 API
  - 开始/停止修炼
  - 经验值计算
  - 境界突破
  - 资源系统

### 备注
- 目前使用基础五行统计（天干 + 地支主五行）
- 进阶版本可考虑加入地支藏干权重计算
- 节气计算暂未实现，月柱按农历月份简化处理
